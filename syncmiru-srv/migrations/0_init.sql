CREATE TYPE "email_reason" AS ENUM (
  'forgotten_password',
  'verify',
  'delete_account'
);

CREATE TYPE "major_desync_action" AS ENUM (
    'rewind',
    'fast-forward'
);

CREATE TYPE "minor_desync_action" AS ENUM (
    'speed-up',
    'slow-down'
);

CREATE TABLE "users" (
                         "id" INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                         "username" varchar(16) UNIQUE NOT NULL,
                         "display_name" varchar(24) NOT NULL,
                         "email" varchar(320) UNIQUE NOT NULL,
                         "avatar" bytea,
                         "hash" varchar(128) NOT NULL,
                         "reg_at" timestamptz NOT NULL DEFAULT (now()),
                         "reg_tkn_id" integer,
                         "verified" bool NOT NULL DEFAULT false
);

CREATE TABLE "reg_tkn" (
                           "id" INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                           "name" varchar(16) UNIQUE NOT NULL,
                           "key" varchar(24) NOT NULL,
                           "max_reg" integer,
                           "used" integer NOT NULL DEFAULT 0,
                           check (max_reg >= used)
);

CREATE TABLE "room" (
                        "id" INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                        "name" varchar(32) NOT NULL,
                        "playback_speed" decimal(3,2) NOT NULL,
                        "desync_tolerance" decimal(2,1) NOT NULL,
                        "minor_desync_playback_change" decimal(3,2) NOT NULL,
                        "minor_desync_action" minor_desync_action NOT NULL,
                        "major_desync_min" decimal(2,1) NOT NULL,
                        "major_desync_action" major_desync_action NOT NULL,
                        check (playback_speed >= 1 and playback_speed <= 2),
                        check (minor_desync_playback_change >= 0.01 and minor_desync_playback_change <= 0.1),
                        check (major_desync_min >= 4 and major_desync_min <= 10)
);

CREATE TABLE "session" (
                           "id" INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                           "os" varchar(16) NOT NULL,
                           "device_name" text NOT NULL,
                           "hash" varchar(64) UNIQUE NOT NULL,
                           "last_access_at" timestamptz NOT NULL DEFAULT (now()),
                           "user_id" integer UNIQUE NOT NULL
);

CREATE TABLE "email_tkn_log" (
                                 "id" INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                                 "reason" email_reason NOT NULL,
                                 "hash" varchar(128) NOT NULL,
                                 "user_id" integer NOT NULL,
                                 "sent_at" timestamptz NOT NULL DEFAULT (now()),
                                 "used" bool NOT NULL DEFAULT false
);

CREATE TABLE "change_email_log" (
                                    "id" INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                                    "hash_from" varchar(128) NOT NULL,
                                    "hash_to" varchar(128) NOT NULL,
                                    "user_id" integer NOT NULL,
                                    "sent_at" timestamptz NOT NULL DEFAULT (now()),
                                    "used" bool NOT NULL DEFAULT false
);

CREATE TABLE "settings" (
                                    "id" INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                                    "playback_speed" decimal(3,2) NOT NULL,
                                    "desync_tolerance" decimal(2,1) NOT NULL,
                                    "minor_desync_playback_change" decimal(3,2) NOT NULL,
                                    "minor_desync_action" minor_desync_action NOT NULL,
                                    "major_desync_min" decimal(2,1) NOT NULL,
                                    "major_desync_action" major_desync_action NOT NULL,
                                    "show_order" integer ARRAY,
                                    check (playback_speed >= 1 and playback_speed <= 2),
                                    check (minor_desync_playback_change >= 0.01 and minor_desync_playback_change <= 0.1),
                                    check (major_desync_min >= 4 and major_desync_min <= 10)
);

ALTER TABLE "users" ADD FOREIGN KEY ("reg_tkn_id") REFERENCES "reg_tkn" ("id") on delete set null;

ALTER TABLE "session" ADD FOREIGN KEY ("user_id") REFERENCES "users" ("id") on delete cascade;

ALTER TABLE "email_tkn_log" ADD FOREIGN KEY ("user_id") REFERENCES "users" ("id") on delete cascade;

ALTER TABLE "change_email_log" ADD FOREIGN KEY ("user_id") REFERENCES "users" ("id") on delete cascade;
